!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Planck=e.Planck||{})}(this,function(e){"use strict";function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,t=Symbol(e);return function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(e){return e};return void 0===e[t]&&(e[t]=n({})),e[t]}}function n(e){var t=z(e);return{set target(e){t.target=void 0!==e?e:null},set currentTarget(e){t.currentTarget=void 0!==e?e:null},set eventPhase(e){t.eventPhase=void 0!==e?e:null}}}function r(e,t){if("function"==typeof t)t(e);else{if("function"!=typeof t.handleEvent)throw new Error("Listener is neither function nor event listener");t.handleEvent(e)}}function o(e,t){var n=M(e);t!==n.size&&(n.size=t,e.dispatchEvent({type:"size"}))}function i(e,t){var n=M(e);t!==n.progress&&(n.progress=t,e.dispatchEvent({type:"progress"}))}function a(e,t){var n=M(e);t!==n.determinate&&(n.determinate=t,e.dispatchEvent({type:"determinate"}))}function u(e){return e.map(function(e){return Array.isArray(e)?u(e):e&&"function"==typeof e.load?e:(e.url||e).endsWith(".js")?new B(e):new C(e)})}function s(e){return e.reduce(function(e,t){return Array.isArray(t)?e.concat(s(t)):(e.push(t),e)},[])}var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},l=(function(){function e(e){this.value=e}function t(t){function n(o,i){try{var a=t[o](i),u=a.value;u instanceof e?Promise.resolve(u.value).then(function(e){n("next",e)},function(e){n("throw",e)}):r(a.done?"return":"normal",a.value)}catch(e){r("throw",e)}}function r(e,t){switch(e){case"return":o.resolve({value:t,done:!0});break;case"throw":o.reject(t);break;default:o.resolve({value:t,done:!1})}(o=o.next)?n(o.key,o.arg):i=null}var o,i;this._invoke=function(e,t){return new Promise(function(r,a){var u={key:e,arg:t,resolve:r,reject:a,next:null};i?i=i.next=u:(o=i=u,n(e,t))})},"function"!=typeof t.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype.throw=function(e){return this._invoke("throw",e)},t.prototype.return=function(e){return this._invoke("return",e)}}(),function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}),f=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},d=function e(t,n,r){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var i=Object.getPrototypeOf(t);return null===i?void 0:e(i,n,r)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(r)},h=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},v=function(e,t){var n={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},y=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},g=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},m=Symbol("_cachedApplicationRef"),b=Symbol("_mixinRef"),P=Symbol("_originalMixin"),k=function(e,t){return Object.setPrototypeOf(t,e),e[P]||(e[P]=e),t},w=function(e){return k(e,function(t){var n=e[m];if(n||(n=e[m]=Symbol(e.name)),t.hasOwnProperty(n))return t[n];var r=e(t);return t[n]=r,r})},E=function(e){return Symbol.hasInstance&&!e.hasOwnProperty(Symbol.hasInstance)&&Object.defineProperty(e,Symbol.hasInstance,{value:function(e){for(var t=this[P];null!=e;){if(e.hasOwnProperty(b)&&e[b]===t)return!0;e=Object.getPrototypeOf(e)}return!1}}),e},_=function(e){return k(e,function(t){var n=e(t);return n.prototype[b]=e[P],n})},O=function(){function e(t){l(this,e),this.superclass=t}return f(e,[{key:"with",value:function(){return Array.from(arguments).reduce(function(e,t){return t(e)},this.superclass)}}]),e}(),S=function(){try{if(new Function("return this === window")())return"browser"}catch(e){}try{if(new Function("return this === self")())return"worker"}catch(e){}try{if(new Function("return this === global")())return"node"}catch(e){}}(),L=void 0;switch(S){case"browser":L=window;break;case"worker":L=self;break;case"node":L=global}var j={type:S,self:L},z=t("Event"),A=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};l(this,e),this.init(t)}return f(e,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.type,n=e.captures,r=void 0!==n&&n,o=e.bubbles,i=void 0===o||o,a=e.cancelable,u=void 0===a||a,s=z(this);return s.type=void 0!==t?t:null,s.captures=!!r,s.bubbles=!!i,s.cancelable=!!u,s.timeStamp=j.self.performance&&j.self.performance.now&&j.self.performance.now()||Date.now(),s.propagationStopped=!1,s.immediatePropagationStopped=!1,s.defaultPrevented=!1,s.target=null,s.currentTarget=null,s.eventPhase=null,this}},{key:"stopPropagation",value:function(){z(this).propagationStopped=!0}},{key:"stopImmediatePropagation",value:function(){var e=z(this);e.propagationStopped=!0,e.immediatePropagationStopped=!0}},{key:"preventDefault",value:function(){this.cancelable&&(z(this).defaultPrevented=!0)}},{key:"type",get:function(){return z(this).type}},{key:"target",get:function(){return z(this).target}},{key:"currentTarget",get:function(){return z(this).currentTarget}},{key:"eventPhase",get:function(){return z(this).eventPhase}},{key:"captures",get:function(){return z(this).captures}},{key:"bubbles",get:function(){return z(this).bubbles}},{key:"cancelable",get:function(){return z(this).cancelable}},{key:"timeStamp",get:function(){return z(this).timeStamp}},{key:"propagationStopped",get:function(){return z(this).propagationStopped}},{key:"immediatePropagationStopped",get:function(){return z(this).immediatePropagationStopped}},{key:"defaultPrevented",get:function(){return z(this).defaultPrevented}}]),e}(),x=function(e){function t(){return l(this,t),y(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return h(t,A),f(t,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.type,o=e.target,i=v(e,["type","target"]);return d(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"init",this).call(this,p({type:r},i)),n(this).target=void 0!==o?o:null,this}}]),t}(),q=function(e){function t(){return l(this,t),y(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return h(t,x),f(t,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=e.type,r=e.target,o=e.captures,i=void 0!==o&&o,a=e.bubbles,u=void 0!==a&&a,s=v(e,["type","target","captures","bubbles"]);d(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"init",this).call(this,{type:n,target:r,captures:i,bubbles:u});for(var c=Object.keys(s),l=0;l<c.length;++l){var f=c[l];if({}.hasOwnProperty.call(this,f))throw new Error('Name "'+f+'" cannot be used for event property');this[f]=s[f]}return this}}]),t}(),I=t("EventDispatcherMixin"),D=function(e){return w(E(_(e)))}(function(e){return function(t){function o(){var e;l(this,o);for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=y(this,(e=o.__proto__||Object.getPrototypeOf(o)).call.apply(e,[this].concat(n)));return I(i).listeners={},i}return h(o,e),f(o,[{key:"addEventListener",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if("function"!=typeof t&&"object"!==(void 0===t?"undefined":c(t)))throw new Error("Attempt to add non-function non-object listener");var r=I(this);void 0===r.listeners[e]&&(r.listeners[e]={bubble:[],capture:[]});var o=n?r.listeners[e].capture:r.listeners[e].bubble;o.includes(t)||o.push(t)}},{key:"removeEventListener",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=I(this);if(void 0!==r.listeners[e]){var o=n?r.listeners[e].capture:r.listeners[e].bubble,i=o.indexOf(t);-1!==i&&o.splice(i,1)}}},{key:"on",value:function(){return this.addEventListener.apply(this,arguments),this}},{key:"off",value:function(){return this.removeEventListener.apply(this,arguments),this}},{key:"once",value:function(e,t){for(var n=arguments.length,o=Array(n>2?n-2:0),i=2;i<n;i++)o[i-2]=arguments[i];var a=this;return this.addEventListener.apply(this,[e,function n(i){r(i,t),a.removeEventListener.apply(a,[e,n].concat(o))}].concat(o)),this}},{key:"dispatchEvent",value:function(e){var t=e;t instanceof A||(t=new q(e));var o=n(t);null===t.target&&(o.target=this),o.currentTarget=this;var i=I(this).listeners[t.type];if(void 0!==i){var a=t.eventPhase;if(!a||"target"===a||"capture"===a)for(var u=0;u<i.capture.length;++u)if(r(t,i.capture[u]),t.immediatePropagationStopped)return;if(!a||"target"===a||"bubble"===a)for(var s=0;s<i.bubble.length;++s)if(r(t,i.bubble[s]),t.immediatePropagationStopped)return}}}]),o}()}),T=function(e){function t(){return l(this,t),y(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return h(t,e),t}(function(e){return new O(e)}(function(){function e(){l(this,e)}return e}()).with(D)),M=t("DataLoader"),C=function(e){function t(e){l(this,t);var n=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),r=M(n);return r.request=null,void 0!==e?(r.url=e.url||e,r.size=e.size||0):(r.url=null,r.size=0),r.progress=0,r.determinate=!1,r.completed=!1,r.failed=!1,n.onInitialProgress=n.onInitialProgress.bind(n),n.onProgress=n.onProgress.bind(n),n.onLoadend=n.onLoadend.bind(n),n}return h(t,T),f(t,[{key:"load",value:function(){var e=this,t=M(this);return void 0!==t.promise?t.promise:null===this.url?Promise.reject(new Error("Attempt to load without url")):(t.promise=new Promise(function(n,r){var o=new XMLHttpRequest;o.addEventListener("progress",e.onInitialProgress,!1),o.addEventListener("progress",e.onProgress,!1),o.addEventListener("loadend",e.onLoadend,!1),o.open("get",e.url),t.request=o,t.resolve=n,t.reject=r,e.onBeforeLoading(o),o.send()}),t.promise)}},{key:"abort",value:function(){var e=M(this);void 0!==e.promise&&e.request.abort()}},{key:"onInitialProgress",value:function(e){var t=M(this),n=e.target;n.removeEventListener("progress",this.onInitialProgress,!1),n.status<200||n.status>=300||(0===t.size&&o(this,e.total),0!==t.size&&a(this,!0))}},{key:"onProgress",value:function(e){var t=M(this);t.determinate&&i(this,Math.min(1,e.loaded/t.size))}},{key:"onLoadend",value:function(e){var t=this,n=M(this),r=e.target;r.removeEventListener("progress",this.onInitialProgress,!1),r.removeEventListener("progress",this.onProgress,!1),r.removeEventListener("loadend",this.onLoadend,!1),n.determinate||a(this,!0),r.status>=200&&r.status<300?(i(this,1),Promise.resolve(this.onAfterLoading(r)).then(function(){n.completed=!0,n.resolve(r),t.dispatchEvent({type:"complete"})}).catch(function(e){n.failed=!0,n.reject(e),t.dispatchEvent({type:"error"})})):(n.failed=!0,n.reject(r.status),this.dispatchEvent({type:"error"}))}},{key:"onBeforeLoading",value:function(e){}},{key:"onAfterLoading",value:function(e){}},{key:"request",get:function(){return M(this).request}},{key:"url",get:function(){return M(this).url}},{key:"size",get:function(){return M(this).size}},{key:"progress",get:function(){return M(this).progress}},{key:"determinate",get:function(){return M(this).determinate}},{key:"completed",get:function(){return M(this).completed}},{key:"failed",get:function(){return M(this).failed}}]),t}(),B=function(e){function t(){return l(this,t),y(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return h(t,C),f(t,[{key:"onAfterLoading",value:function(e){var t=this;return new Promise(function(e,n){var r=document.createElement("script");r.type="text/javascript",r.src=t.url,r.onload=function(){e()},r.onerror=function(e){n(e)};var o=document.getElementsByTagName("script"),i=o[o.length-1];i.parentNode.insertBefore(r,i)})}}]),t}(),F=t("Loader"),R=function(e){function t(){l(this,t);var e=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),n=F(e);n.determinate=!1,n.completed=!1,n.failed=!1,e.onSize=e.onSize.bind(e),e.onProgress=e.onProgress.bind(e),e.onDeterminate=e.onDeterminate.bind(e),e.onComplete=e.onComplete.bind(e),e.onError=e.onError.bind(e);for(var r=arguments.length,o=Array(r),i=0;i<r;i++)o[i]=arguments[i];return n.sequence=u(o),n.loaders=s(n.sequence),n.loaders.forEach(function(t){t.addEventListener("size",e.onSize,!1),t.addEventListener("progress",e.onProgress,!1),t.addEventListener("determinate",e.onDeterminate,!1),t.addEventListener("complete",e.onComplete,!1),t.addEventListener("error",e.onError,!1)}),e}return h(t,T),f(t,[{key:"load",value:function(){var e=F(this);return void 0!==e.promise?e.promise:0===this.loaders.length?Promise.reject():(e.promise=this.constructor.loadSequentially(e.sequence),e.promise)}},{key:"abort",value:function(){var e=F(this);void 0!==e.promise&&e.loaders.forEach(function(e){e.abort()})}},{key:"onSize",value:function(e){e.target.removeEventListener("size",this.onSize,!1),this.dispatchEvent({type:"size"})}},{key:"onProgress",value:function(e){this.dispatchEvent({type:"progress"})}},{key:"onDeterminate",value:function(e){e.target.removeEventListener("determinate",this.onDeterminate,!1);var t=F(this),n=t.loaders.every(function(e){return e.determinate});n!==t.determinate&&(t.determinate=n,this.dispatchEvent({type:"determinate"}))}},{key:"onComplete",value:function(e){var t=F(this),n=t.loaders.every(function(e){return e.completed});n!==t.completed&&(t.completed=n,this.dispatchEvent({type:"complete"}))}},{key:"onError",value:function(e){var t=F(this),n=t.loaders.some(function(e){return e.failed});n!==t.failed&&(t.failed=n,this.dispatchEvent({type:"error"}),t.failed&&this.abort())}},{key:"loaders",get:function(){var e=F(this);return[].concat(g(e.loaders))}},{key:"size",get:function(){return F(this).loaders.reduce(function(e,t){return e+t.size},0)}},{key:"progress",get:function(){var e=F(this);if(0===this.size)return Math.min(1,e.loaders.reduce(function(t,n){return t+n.progress/e.loaders.length},0));var t=e.loaders.filter(function(e){return 0!==e.size}),n=t.reduce(function(e,t){return e+t.size},0)/t.length,r=n*e.loaders.length;return Math.min(1,e.loaders.reduce(function(e,t){return e+t.progress*(t.size||n)/r},0))}},{key:"determinate",get:function(){return F(this).determinate}},{key:"completed",get:function(){return F(this).completed}},{key:"failed",get:function(){return F(this).failed}}],[{key:"loadParallelly",value:function(e){var t=this;return Promise.all(e.map(function(e){return Array.isArray(e)?t.loadSequentially(e):e.load().then(function(e){return[].concat(e)})})).then(function(e){var t;return(t=[]).concat.apply(t,g(e))})}},{key:"loadSequentially",value:function(e){var t=this;return 0===e.length?Promise.resolve([]):e.reduce(function(e,n){return null===e?Array.isArray(n)?t.loadParallelly(n):n.load().then(function(e){return[].concat(e)}):Array.isArray(n)?e.then(function(e){return t.loadParallelly(n).then(function(t){return[].concat(e,t)})}):e.then(function(e){return n.load().then(function(t){return[].concat(e,t)})})},null)}}]),t}();e.DataLoader=C,e.Loader=R,e.ScriptLoader=B,Object.defineProperty(e,"__esModule",{value:!0})});